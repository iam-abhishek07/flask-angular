"use strict";
Object.defineProperty(exports, "__esModule", { value: true });

require("symbol-observable");

const core_1 = require("@angular-devkit/core");
const fs = require("fs");
const path = require("path");
const semver_1 = require("semver");
const stream_1 = require("stream");
const color_1 = require("../utilities/color");
const config_1 = require("../utilities/config");
const packageJson = require('../package.json');
function _fromPackageJson(cwd = process.cwd()) {
    do {
        const packageJsonPath = path.join(cwd, 'node_modules/@angular/cli/package.json');
        if (fs.existsSync(packageJsonPath)) {
            const content = fs.readFileSync(packageJsonPath, 'utf-8');
            if (content) {
                const { version } = JSON.parse(content);
                if (version) {
                    return new semver_1.SemVer(version);
                }
            }
        }
        
        cwd = path.dirname(cwd);
    } while (cwd != path.dirname(cwd));
    return null;
}

if (process.env['NG_CLI_PROFILING']) {
    let profiler;
    try {
        profiler = require('v8-profiler-node8'); 
    }
    catch (err) {
        throw new Error(`Could not require 'v8-profiler-node8'. You must install it separetely with ` +
            `'npm install v8-profiler-node8 --no-save'.\n\nOriginal error:\n\n${err}`);
    }
    profiler.startProfiling();
    const exitHandler = (options) => {
        if (options.cleanup) {
            const cpuProfile = profiler.stopProfiling();
            fs.writeFileSync(path.resolve(process.cwd(), process.env.NG_CLI_PROFILING || '') + '.cpuprofile', JSON.stringify(cpuProfile));
        }
        if (options.exit) {
            process.exit();
        }
    };
    process.on('exit', () => exitHandler({ cleanup: true }));
    process.on('SIGINT', () => exitHandler({ exit: true }));
    process.on('uncaughtException', () => exitHandler({ exit: true }));
}
(async () => {
    
    process.env.BROWSERSLIST_IGNORE_OLD_DATA = '1';
    const disableVersionCheckEnv = process.env['NG_DISABLE_VERSION_CHECK'];
    
    const disableVersionCheck = disableVersionCheckEnv !== undefined &&
        disableVersionCheckEnv !== '0' &&
        disableVersionCheckEnv.toLowerCase() !== 'false';
    if (disableVersionCheck) {
        return (await Promise.resolve().then(() => require('./cli'))).default;
    }
    let cli;
    try {
        const projectLocalCli = require.resolve('@angular/cli', { paths: [process.cwd()] });
        
        const globalVersion = new semver_1.SemVer(packageJson['version']);
        let localVersion;
        let shouldWarn = false;
        try {
            localVersion = _fromPackageJson();
            shouldWarn = localVersion != null && globalVersion.compare(localVersion) > 0;
        }
        catch (e) {
            
            console.error(e);
            shouldWarn = true;
        }
        if (shouldWarn && await config_1.isWarningEnabled('versionMismatch')) {
            const warning = color_1.colors.yellow(core_1.tags.stripIndents `
      Your global Angular CLI version (${globalVersion}) is greater than your local
      version (${localVersion}). The local Angular CLI version is used.

      To disable this warning use "ng config -g cli.warnings.versionMismatch false".
      `);
            
            if (process.argv[2] !== 'completion') {
               
                console.error(warning);
            }
            else {
                
                console.error(warning);
                process.exit(1);
            }
        }
        
        cli = await Promise.resolve().then(() => require(projectLocalCli));
    }
    catch (_a) {
       
        cli = await Promise.resolve().then(() => require('./cli'));
    }
    if ('default' in cli) {
        cli = cli['default'];
    }
    return cli;
})().then(cli => {
    
    let standardInput;
    try {
        standardInput = process.stdin;
    }
    catch (e) {
        process.stdin = new stream_1.Duplex();
        standardInput = process.stdin;
    }
    return cli({
        cliArgs: process.argv.slice(2),
        inputStream: standardInput,
        outputStream: process.stdout,
    });
}).then((exitCode) => {
    process.exit(exitCode);
})
    .catch((err) => {
    
    console.error('Unknown error: ' + err.toString());
    process.exit(127);
});
